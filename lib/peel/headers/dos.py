#!/usr/bin/env python

from paranoia.base.abstract.structure import Structure

from .win32 import *

class DOSHeader(Structure):
   FIELDS = [('e_magic',     WORD),
             ('e_cblp',      WORD),
             ('e_cp',        WORD),
             ('e_crlc',      WORD),
             ('e_cparhdr',   WORD),  
             ('e_minalloc',  WORD),
             ('e_maxalloc',  WORD),
             ('e_ss',        WORD),
             ('e_sp',        WORD),
             ('e_csum',      WORD),
             ('e_ip',        WORD),
             ('e_cs',        WORD),
             ('e_lfarlc',    WORD),
             ('e_ovno',      WORD),
             ('e_res',       WORD),
             ('e_unused1',   LPBYTE,  {'elements': 6}),
             ('e_oemid',     WORD),
             ('e_oeminfo',   WORD),
             ('e_res2',      WORD),
             ('e_unused2',   LPBYTE,  {'elements': 0x12}),
             ('e_lfanew',    DWORD)]

   DOS_WARNING = [0x0E,0x1F,0xBA,0x0E,0x00,0xB4,0x09,0xCD,0x21,0xB8,0x01,0x4C,
                  0xCD,0x21,0x54,0x68,0x69,0x73,0x20,0x70,0x72,0x6F,0x67,0x72,
                  0x61,0x6D,0x20,0x63,0x61,0x6E,0x6E,0x6F,0x74,0x20,0x62,0x65,
                  0x20,0x72,0x75,0x6E,0x20,0x69,0x6E,0x20,0x44,0x4F,0x53,0x20,
                  0x6D,0x6F,0x64,0x65,0x2E,0x0D,0x0D,0x0A,0x24,0x00,0x00,0x00,
                  0x00,0x00,0x00,0x00,0x08,0x73,0xA6,0x53,0x4C,0x12,0xC8,0x00,
                  0x4C,0x12,0xC8,0x00,0x4C,0x12,0xC8,0x00,0x45,0x6A,0x5D,0x00,
                  0x45,0x12,0xC8,0x00,0x4C,0x12,0xC9,0x00,0xD8,0x13,0xC8,0x00,
                  0x45,0x6A,0x5B,0x00,0x6D,0x12,0xC8,0x00,0x45,0x6A,0x4B,0x00,
                  0x57,0x12,0xC8,0x00,0x45,0x6A,0x4C,0x00,0xCE,0x12,0xC8,0x00,
                  0x45,0x6A,0x5C,0x00,0x4D,0x12,0xC8,0x00,0x45,0x6A,0x59,0x00,
                  0x4D,0x12,0xC8,0x00,0x52,0x69,0x63,0x68,0x4C,0x12,0xC8,0x00,
                  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]

   def __init__(self, **kwargs):
      Struct.__init__(self, **kwargs)

      if kwargs.setdefault('set_defaults',0):
         self.set_defaults()

   def set_defaults(self):
      self.e_magic.set_value(IMAGE_DOS_SIGNATURE)
      self.e_lfanew.set_value(0xE0)

IMAGE_DOS_HEADER = DOSHeader
